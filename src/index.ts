import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { 
  CallToolRequestSchema, 
  CallToolResult, 
  ListToolsRequestSchema,
  Tool 
} from "@modelcontextprotocol/sdk/types.js";
import { z } from "zod";
import { PlaywrightServer } from "./servers/playwright-server.js";

// Cr√©er le serveur MCP principal
const server = new Server(
  {
    name: "web-scraper-to-sheets",
    version: "1.0.0",
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

// Initialiser le serveur Playwright
const playwrightServer = new PlaywrightServer();

// Schemas de validation Zod
const ScrapeTitleSchema = z.object({
  url: z.string().url("URL invalide"),
});

const WriteToSheetSchema = z.object({
  spreadsheetUrl: z.string().url("URL de la feuille Google Sheets invalide"),
  data: z.array(z.array(z.string())).min(1, "Au moins une ligne de donn√©es requise"),
  startCell: z.string().default("A1"),
});

const AppendToSheetSchema = z.object({
  spreadsheetUrl: z.string().url("URL de la feuille Google Sheets invalide"),
  data: z.array(z.string()).min(1, "Au moins une donn√©e requise"),
});

const ScrapeAndSaveSchema = z.object({
  url: z.string().url("URL invalide"),
  spreadsheetUrl: z.string().url("URL de la feuille Google Sheets invalide"),
});

const ScrapeTimeSchema = z.object({
  // Pas de param√®tres n√©cessaires pour r√©cup√©rer l'heure
});

const SaveTimeToSheetSchema = z.object({
  spreadsheetUrl: z.string().url("URL de la feuille Google Sheets invalide"),
});

// Liste des outils disponibles
const tools: Tool[] = [
  {
    name: "scrape-title",
    description: "R√©cup√®re le titre d'une page web en utilisant Playwright",
    inputSchema: {
      type: "object",
      properties: {
        url: {
          type: "string",
          format: "uri",
          description: "L'URL de la page web √† analyser",
        },
      },
      required: ["url"],
    },
  },
  {
    name: "write-to-sheet",
    description: "√âcrit des donn√©es dans une feuille Google Sheets via l'interface web",
    inputSchema: {
      type: "object",
      properties: {
        spreadsheetUrl: {
          type: "string",
          format: "uri",
          description: "L'URL compl√®te de la feuille Google Sheets",
        },
        data: {
          type: "array",
          items: {
            type: "array",
            items: { type: "string" },
          },
          description: "Les donn√©es √† √©crire (tableau 2D)",
        },
        startCell: {
          type: "string",
          description: "La cellule de d√©part (ex: A1, B2, etc.)",
          default: "A1",
        },
      },
      required: ["spreadsheetUrl", "data"],
    },
  },
  {
    name: "append-to-sheet",
    description: "Ajoute une nouvelle ligne √† la fin d'une feuille Google Sheets",
    inputSchema: {
      type: "object",
      properties: {
        spreadsheetUrl: {
          type: "string",
          format: "uri",
          description: "L'URL compl√®te de la feuille Google Sheets",
        },
        data: {
          type: "array",
          items: { type: "string" },
          description: "Les donn√©es √† ajouter en tant que nouvelle ligne",
        },
      },
      required: ["spreadsheetUrl", "data"],
    },
  },
  {
    name: "scrape-and-save",
    description: "R√©cup√®re le titre d'une page web et l'ajoute √† une feuille Google Sheets",
    inputSchema: {
      type: "object",
      properties: {
        url: {
          type: "string",
          format: "uri",
          description: "L'URL de la page web √† analyser",
        },
        spreadsheetUrl: {
          type: "string",
          format: "uri",
          description: "L'URL compl√®te de la feuille Google Sheets",
        },
      },
      required: ["url", "spreadsheetUrl"],
    },
  },
  {
    name: "scrape-time",
    description: "R√©cup√®re l'heure exacte depuis quelleheureestil.fr",
    inputSchema: {
      type: "object",
      properties: {},
      required: [],
    },
  },
  {
    name: "save-time-to-sheet",
    description: "R√©cup√®re l'heure exacte et l'ajoute √† une feuille Google Sheets",
    inputSchema: {
      type: "object",
      properties: {
        spreadsheetUrl: {
          type: "string",
          format: "uri",
          description: "L'URL compl√®te de la feuille Google Sheets",
        },
      },
      required: ["spreadsheetUrl"],
    },
  },
];

// Gestionnaire pour lister les outils
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return { tools };
});

// Gestionnaire pour ex√©cuter les outils
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  // Outil pour r√©cup√©rer le titre d'une page web
  if (request.params.name === "scrape-title") {
    try {
      const args = ScrapeTitleSchema.parse(request.params.arguments);
      const title = await playwrightServer.scrapePageTitle(args.url);
      
      return {
        content: [
          {
            type: "text",
            text: `Titre de la page: ${title}`,
          },
        ],
      } as CallToolResult;
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors du scraping: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  // Outil pour √©crire dans une feuille Google Sheets
  if (request.params.name === "write-to-sheet") {
    try {
      const args = WriteToSheetSchema.parse(request.params.arguments);
      const result = await playwrightServer.writeToGoogleSheets(
        args.spreadsheetUrl,
        args.data,
        args.startCell
      );
      
      return {
        content: [
          {
            type: "text",
            text: result.success ? 
              `‚úÖ ${result.message}` : 
              `‚ùå ${result.message}`,
          },
        ],
        isError: !result.success,
      } as CallToolResult;
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors de l'√©criture: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  // Outil pour ajouter une ligne √† une feuille Google Sheets
  if (request.params.name === "append-to-sheet") {
    try {
      const args = AppendToSheetSchema.parse(request.params.arguments);
      const result = await playwrightServer.appendToGoogleSheets(
        args.spreadsheetUrl,
        args.data
      );
      
      return {
        content: [
          {
            type: "text",
            text: result.success ? 
              `‚úÖ ${result.message}` : 
              `‚ùå ${result.message}`,
          },
        ],
        isError: !result.success,
      } as CallToolResult;
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors de l'ajout: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  // Outil combin√© pour scraper et sauvegarder
  if (request.params.name === "scrape-and-save") {
    try {
      const args = ScrapeAndSaveSchema.parse(request.params.arguments);
      
      // 1. Scraper le titre
      const title = await playwrightServer.scrapePageTitle(args.url);
      
      // 2. Pr√©parer les donn√©es pour la feuille
      const timestamp = new Date().toLocaleString('fr-FR');
      const data = [timestamp, args.url, title];
      
      // 3. Ajouter dans la feuille
      const result = await playwrightServer.appendToGoogleSheets(
        args.spreadsheetUrl,
        data
      );
      
      if (result.success) {
        return {
          content: [
            {
              type: "text",
              text: `‚úÖ Scraping et sauvegarde termin√©s!\n` +
                    `üåê URL: ${args.url}\n` +
                    `üìÑ Titre: ${title}\n` +
                    `üìä ${result.message}\n` +
                    `‚è∞ Horodatage: ${timestamp}`,
            },
          ],
        } as CallToolResult;
      } else {
        return {
          content: [
            {
              type: "text",
              text: `‚ö†Ô∏è Scraping r√©ussi mais erreur lors de la sauvegarde:\n` +
                    `üìÑ Titre r√©cup√©r√©: ${title}\n` +
                    `‚ùå Erreur: ${result.message}`,
            },
          ],
          isError: true,
        } as CallToolResult;
      }
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors du scraping et sauvegarde: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  // Outil pour r√©cup√©rer l'heure actuelle
  if (request.params.name === "scrape-time") {
    try {
      const timeInfo = await playwrightServer.scrapeCurrentTime();
      
      return {
        content: [
          {
            type: "text",
            text: `üïê Heure exacte r√©cup√©r√©e:\n` +
                  `‚è∞ Heure: ${timeInfo.time}\n` +
                  `üìÖ Date: ${timeInfo.date}\n` +
                  `üåê Source: ${timeInfo.source}`,
          },
        ],
      } as CallToolResult;
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors de la r√©cup√©ration de l'heure: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  // Outil pour r√©cup√©rer l'heure et la sauvegarder dans Google Sheets
  if (request.params.name === "save-time-to-sheet") {
    try {
      const args = SaveTimeToSheetSchema.parse(request.params.arguments);
      
      // 1. R√©cup√©rer l'heure
      const timeInfo = await playwrightServer.scrapeCurrentTime();
      
      // 2. Pr√©parer les donn√©es pour la feuille
      const data = [timeInfo.date, timeInfo.time, timeInfo.source];
      
      // 3. Ajouter dans la feuille
      const result = await playwrightServer.appendToGoogleSheets(
        args.spreadsheetUrl,
        data
      );
      
      if (result.success) {
        return {
          content: [
            {
              type: "text",
              text: `‚úÖ Heure sauvegard√©e avec succ√®s!\n` +
                    `‚è∞ Heure: ${timeInfo.time}\n` +
                    `üìÖ Date: ${timeInfo.date}\n` +
                    `üåê Source: ${timeInfo.source}\n` +
                    `üìä ${result.message}`,
            },
          ],
        } as CallToolResult;
      } else {
        return {
          content: [
            {
              type: "text",
              text: `‚ö†Ô∏è Heure r√©cup√©r√©e mais erreur lors de la sauvegarde:\n` +
                    `‚è∞ Heure r√©cup√©r√©e: ${timeInfo.time}\n` +
                    `‚ùå Erreur: ${result.message}`,
            },
          ],
          isError: true,
        } as CallToolResult;
      }
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Erreur lors de la r√©cup√©ration et sauvegarde de l'heure: ${error instanceof Error ? error.message : String(error)}`,
          },
        ],
        isError: true,
      } as CallToolResult;
    }
  }

  throw new Error(`Outil inconnu: ${request.params.name}`);
});

async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error("üöÄ Serveur MCP Web Scraper to Sheets (Playwright) d√©marr√©");
  
  // Configurer le nettoyage pour Playwright
  playwrightServer.setupCleanup();
}

if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch((error) => {
    console.error("‚ùå Erreur fatale:", error);
    process.exit(1);
  });
}
